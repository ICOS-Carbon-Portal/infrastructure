---
#
# Overview:     Get onlyoffice container id  
# Ver:          251103
# Updated:      
#
# get_onlyoffice_container_id_and_load_fonts.yml

- hosts: fsicos2
  become: true
  gather_facts: false

  vars:
    container_name: "onlyoffice"
    host_fonts_dir: "/docker/nextcloud/onlyoffice-fonts/aptos_fonts"
    container_fonts_dir: "/usr/share/fonts/truetype/custom"

  tasks:
    - name: Detect ONLYOFFICE container ID (short)
      check_mode: no
      shell: >
        docker ps -q --filter "name={{ container_name }}" | head -n1
      args:
        executable: /bin/bash
      register: container_id
      changed_when: false

    - name: Fail if container not found
      assert:
        that: container_id.stdout | trim | length > 0
        fail_msg: "ONLYOFFICE container not found (name={{ container_name }})."

    - name: Ensure fonts directory exists inside the container
      check_mode: no
      shell: >
        docker exec -u 0 {{ container_id.stdout | trim }}
        bash -lc 'mkdir -p {{ container_fonts_dir }}'
      args:
        executable: /bin/bash
      changed_when: false

    - name: Copy fonts into the container
      check_mode: no
      shell: >
        docker cp {{ host_fonts_dir }}/.
        {{ container_id.stdout | trim }}:{{ container_fonts_dir }}/
      args:
        executable: /bin/bash
      changed_when: false

    - name: Refresh font caches and ONLYOFFICE metadata
      check_mode: no
      shell: >
        docker exec -u 0 {{ container_id.stdout | trim }}
        bash -lc 'fc-cache -f -v && /usr/bin/documentserver-generate-allfonts.sh'
      args:
        executable: /bin/bash
      changed_when: false

    - name: Print container ID
      debug:
        msg: "{{ container_id.stdout | trim }}"
